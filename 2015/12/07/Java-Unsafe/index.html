<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>Java Unsafe 类解读 | Full Stacker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Java不能直接访问操作系统底层，而是通过本地方法来访问。Unsafe类提供了硬件级别的原子操作。Unsafe提供了主要提供了3个功能:  通过Unsafe分配内存，释放内存； 定位对象字段的内存位置，通过内存位置修改对象的字段值； 挂起线程与恢复线程； CAS操作">
<meta name="keywords" content="Java">
<meta property="og:type" content="article">
<meta property="og:title" content="Java Unsafe 类解读">
<meta property="og:url" content="http://yoursite.com/2015/12/07/Java-Unsafe/index.html">
<meta property="og:site_name" content="Full Stacker">
<meta property="og:description" content="Java不能直接访问操作系统底层，而是通过本地方法来访问。Unsafe类提供了硬件级别的原子操作。Unsafe提供了主要提供了3个功能:  通过Unsafe分配内存，释放内存； 定位对象字段的内存位置，通过内存位置修改对象的字段值； 挂起线程与恢复线程； CAS操作">
<meta property="og:updated_time" content="2018-01-21T00:04:11.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Java Unsafe 类解读">
<meta name="twitter:description" content="Java不能直接访问操作系统底层，而是通过本地方法来访问。Unsafe类提供了硬件级别的原子操作。Unsafe提供了主要提供了3个功能:  通过Unsafe分配内存，释放内存； 定位对象字段的内存位置，通过内存位置修改对象的字段值； 挂起线程与恢复线程； CAS操作">
  
    <link rel="alternative" href="/atom.xml" title="Full Stacker" type="application/atom+xml">
  
  
    
      <link rel="icon" href="/favicon.png">
    
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
				
					<img lazy-src="/assets/imgSite/avatar.jpg" class="js-avatar">
				
			
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">Michael Cai</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Enjoy coding</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
						
						<li>Links</li>
						
						
						<li>About</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">首页</a></li>
				        
							<li><a href="/archives">归档</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/a284628487" title="github">github</a>
					        
								<a class="mail" target="_blank" href="mailto:284628487@qq.com" title="mail">mail</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Algorighm/" style="font-size: 11px;">Algorighm</a> <a href="/tags/Android/" style="font-size: 17px;">Android</a> <a href="/tags/Android源码/" style="font-size: 11px;">Android源码</a> <a href="/tags/Animation/" style="font-size: 11px;">Animation</a> <a href="/tags/Annotation/" style="font-size: 10px;">Annotation</a> <a href="/tags/CSS3/" style="font-size: 10px;">CSS3</a> <a href="/tags/Cordova/" style="font-size: 10px;">Cordova</a> <a href="/tags/ES6-ES7/" style="font-size: 14px;">ES6/ES7</a> <a href="/tags/Express/" style="font-size: 11px;">Express</a> <a href="/tags/Fetch/" style="font-size: 10px;">Fetch</a> <a href="/tags/Git-SVN/" style="font-size: 10px;">Git/SVN</a> <a href="/tags/HTTP/" style="font-size: 11px;">HTTP</a> <a href="/tags/HTTPS/" style="font-size: 11px;">HTTPS</a> <a href="/tags/Html/" style="font-size: 10px;">Html</a> <a href="/tags/IO/" style="font-size: 12px;">IO</a> <a href="/tags/Interceptor/" style="font-size: 10px;">Interceptor</a> <a href="/tags/Java/" style="font-size: 18px;">Java</a> <a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/MySQL/" style="font-size: 10px;">MySQL</a> <a href="/tags/NodeJS/" style="font-size: 20px;">NodeJS</a> <a href="/tags/Observable/" style="font-size: 10px;">Observable</a> <a href="/tags/OkHttp3/" style="font-size: 11px;">OkHttp3</a> <a href="/tags/Optimize/" style="font-size: 14px;">Optimize</a> <a href="/tags/Promise/" style="font-size: 11px;">Promise</a> <a href="/tags/React/" style="font-size: 19px;">React</a> <a href="/tags/React-Redux/" style="font-size: 15px;">React-Redux</a> <a href="/tags/React-Router/" style="font-size: 16px;">React-Router</a> <a href="/tags/Retrofit2/" style="font-size: 12px;">Retrofit2</a> <a href="/tags/RxJava/" style="font-size: 13px;">RxJava</a> <a href="/tags/Soap/" style="font-size: 10px;">Soap</a> <a href="/tags/System/" style="font-size: 10px;">System</a> <a href="/tags/async/" style="font-size: 10px;">async</a> <a href="/tags/await/" style="font-size: 10px;">await</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.cnblogs.com/a284628487/">原cnblog1</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.cnblogs.com/284628487a/">原cnblogs2</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">全栈工程师一枚</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">Michael Cai</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				
					<img lazy-src="null/assets/imgSite/avatar.jpg" class="js-avatar">
				
			</div>
			<hgroup>
			  <h1 class="header-author">Michael Cai</h1>
			</hgroup>
			
			<p class="header-subtitle">Enjoy coding</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">首页</a></li>
		        
					<li><a href="/archives">归档</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/a284628487" title="github">github</a>
			        
						<a class="mail" target="_blank" href="mailto:284628487@qq.com" title="mail">mail</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-Java-Unsafe" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/07/Java-Unsafe/" class="article-date">
  	<time datetime="2015-12-07T03:42:30.000Z" itemprop="datePublished">2015-12-07</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Java Unsafe 类解读
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li></ul>
	</div>

        


        
            <div class="bookicon"></div>
            <div class="article-hit">
              <span id="busuanzi_container_page_pv">
                    热度 <span id="busuanzi_value_page_pv"></span>℃</span>
            </div>
        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Java不能直接访问操作系统底层，而是通过本地方法来访问。<strong>Unsafe</strong>类提供了硬件级别的原子操作。<br><strong>Unsafe</strong>提供了主要提供了3个功能:</p>
<ul>
<li>通过Unsafe分配内存，释放内存；</li>
<li>定位对象字段的内存位置，通过内存位置修改对象的字段值；</li>
<li>挂起线程与恢复线程；</li>
<li>CAS操作</li>
</ul>
<a id="more"></a>
<h2 id="内存分配、释放"><a href="#内存分配、释放" class="headerlink" title="内存分配、释放"></a>内存分配、释放</h2><p>类中提供的3个本地方法<strong>allocateMemory</strong>、<strong>reallocateMemory</strong>、<strong>freeMemory</strong>分别用于分配内存，扩充内存和释放内存，与C语言中的3个方法对应。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">long</span> <span class="title">allocateMemory</span><span class="params">(<span class="keyword">long</span> l)</span></span>;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">long</span> <span class="title">reallocateMemory</span><span class="params">(<span class="keyword">long</span> l, <span class="keyword">long</span> l1)</span></span>;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">freeMemory</span><span class="params">(<span class="keyword">long</span> l)</span></span>;</div></pre></td></tr></table></figure>
<h2 id="字段定位与修改"><a href="#字段定位与修改" class="headerlink" title="字段定位与修改"></a>字段定位与修改</h2><ul>
<li><strong>objectFieldOffset</strong></li>
</ul>
<p>通过<strong>objectFieldOffset(Field field)</strong>方法实现Java中对象的字段的定位，该方法返回给定<strong>field</strong>的内存地址偏移量，这个值对于给定的<strong>filed</strong>是唯一的且是固定不变的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Unsafe unsafe = Unsafe.getUnsafe();</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> valueOffset;</div><div class="line"></div><div class="line"><span class="keyword">static</span> &#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        valueOffset = unsafe.objectFieldOffset</div><div class="line">            (AtomicReference.class.getDeclaredField(<span class="string">"value"</span>));</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123; <span class="keyword">throw</span> <span class="keyword">new</span> Error(ex); &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> V value;</div></pre></td></tr></table></figure>
<blockquote>
<p>上面的代码摘自<strong>AtomicReference<v></v></strong>。</p>
</blockquote>
<ul>
<li><strong>getIntVolatile</strong></li>
</ul>
<p><strong>getIntVolatile</strong>方法获取对象中<strong>offset</strong>偏移地址对应的整型<strong>field</strong>的值,支持<strong>volatile</strong> <strong>load</strong>语义。</p>
<ul>
<li><strong>getLong</strong></li>
</ul>
<p><strong>getLong</strong>方法获取对象中<strong>offset</strong>偏移地址对应的<strong>long</strong>型<strong>field</strong>的值</p>
<ul>
<li><strong>arrayBaseOffset</strong> &amp; <strong>arrayIndexScale</strong> 数组字段定位</li>
</ul>
<p>Unsafe类中有很多以<strong>BASE_OFFSET</strong>结尾的常量，比如ARRAY_INT_BASE_OFFSET，ARRAY_BYTE_BASE_OFFSET等，这些常量值是通过<strong>arrayBaseOffset</strong>方法得到的。它是一个本地方法，可以获取数组第一个元素的偏移地址。<br>Unsafe类中还有很多以<strong>INDEX_SCALE</strong>结尾的常量，比如 ARRAY_INT_INDEX_SCALE ， ARRAY_BYTE_INDEX_SCALE等，这些常量值是通过<strong>arrayIndexScale</strong>方法得到的。它也是一个本地方法，可以获取数组的转换因子，也就是数组中元素的增量地址。</p>
<p>将<strong>arrayBaseOffset</strong>与<strong>arrayIndexScale</strong>配合使用，可以定位数组中每个元素在内存中的位置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Unsafe</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ARRAY_INT_BASE_OFFSET;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ARRAY_INT_INDEX_SCALE;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">long</span> <span class="title">objectFieldOffset</span><span class="params">(Field field)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">getIntVolatile</span><span class="params">(Object obj, <span class="keyword">long</span> l)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">long</span> <span class="title">getLong</span><span class="params">(Object obj, <span class="keyword">long</span> l)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">arrayBaseOffset</span><span class="params">(Class class1)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">arrayIndexScale</span><span class="params">(Class class1)</span></span>;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> </div><div class="line">    &#123;</div><div class="line">        ARRAY_INT_BASE_OFFSET = theUnsafe.arrayBaseOffset([I);</div><div class="line">        ARRAY_INT_INDEX_SCALE = theUnsafe.arrayIndexScale([I);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下面是一个示例，通过Unsafe修改数组的值。</p>
<blockquote>
<p>该示例在eclipse里不能直接编译，要到项目的属性，Java Compiler，Errors/Warnings中Forbidden reference(access rules)中设置为warning。<br>此外，因为sun.misc.Unsafe包不能直接使用，所有代码里用反射的技巧得到了一个Unsafe的实例。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> sun.misc.Unsafe;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> byteArrayBaseOffset;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> arrayIndexScale;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		Field theUnsafe = Unsafe.class.getDeclaredField(<span class="string">"theUnsafe"</span>);</div><div class="line">		theUnsafe.setAccessible(<span class="keyword">true</span>);</div><div class="line">		Unsafe UNSAFE = (Unsafe) theUnsafe.get(<span class="keyword">null</span>);</div><div class="line">		System.out.println(UNSAFE);</div><div class="line"></div><div class="line">		<span class="keyword">byte</span>[] data = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">10</span>];</div><div class="line">		byteArrayBaseOffset = UNSAFE.arrayBaseOffset(<span class="keyword">byte</span>[].class);</div><div class="line">		arrayIndexScale = UNSAFE.arrayIndexScale(<span class="keyword">byte</span>[].class);</div><div class="line">		</div><div class="line">		System.out.println(byteArrayBaseOffset);</div><div class="line">		System.out.println(arrayIndexScale);</div><div class="line">		UNSAFE.putByte(data, byteArrayBaseOffset, (<span class="keyword">byte</span>) <span class="number">1</span>);</div><div class="line">		UNSAFE.putByte(data, byteArrayBaseOffset + <span class="number">1</span>, (<span class="keyword">byte</span>) <span class="number">2</span>);</div><div class="line">		UNSAFE.putByte(data, byteArrayBaseOffset + <span class="number">5</span>, (<span class="keyword">byte</span>) <span class="number">5</span>);</div><div class="line">		System.out.println(Arrays.toString(data));</div><div class="line">		</div><div class="line">		<span class="keyword">int</span>[] intData = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">2</span>];</div><div class="line">		byteArrayBaseOffset = UNSAFE.arrayBaseOffset(<span class="keyword">byte</span>[].class);</div><div class="line">		arrayIndexScale = UNSAFE.arrayIndexScale(<span class="keyword">int</span>[].class);</div><div class="line">		System.out.println(byteArrayBaseOffset);</div><div class="line">		System.out.println(arrayIndexScale);</div><div class="line">		UNSAFE.putInt(intData, byteArrayBaseOffset, <span class="number">27</span>);</div><div class="line">		UNSAFE.putInt(intData, byteArrayBaseOffset + arrayIndexScale, <span class="number">29</span>);</div><div class="line">		</div><div class="line">		System.out.println(Arrays.toString(intData));</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>运行结果：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">sun.misc.Unsafe@<span class="number">6</span>fefa3e7</div><div class="line"><span class="number">16</span></div><div class="line"><span class="number">1</span></div><div class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</div><div class="line"><span class="number">16</span></div><div class="line"><span class="number">4</span></div><div class="line">[<span class="number">27</span>, <span class="number">29</span>]</div></pre></td></tr></table></figure>
<h2 id="线程挂起、恢复"><a href="#线程挂起、恢复" class="headerlink" title="线程挂起、恢复"></a>线程挂起、恢复</h2><p>将一个线程进行挂起是通过<strong>park</strong>方法实现的，调用<strong>park()</strong>后，线程将一直 <strong>阻塞</strong> 直到 <strong>超时</strong> 或者 <strong>中断</strong> 等条件出现。<strong>unpark</strong>可以释放一个被挂起的线程，使其恢复正常。整个并发框架中对线程的挂起操作被封装在<strong>LockSupport</strong>类中，LockSupport类中有各种版本pack方法，但最终都调用了<strong>Unsafe.park()</strong>方法。</p>
<p>LockSupport.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LockSupport</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setBlocker</span><span class="params">(Thread t, Object arg)</span> </span>&#123;</div><div class="line">        <span class="comment">// Even though volatile, hotspot doesn't need a write barrier here.</span></div><div class="line">        U.putObject(t, PARKBLOCKER, arg);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Makes available the permit for the given thread, if it</div><div class="line">     * was not already available.  If the thread was blocked on</div><div class="line">     * &#123;<span class="doctag">@code</span> park&#125; then it will unblock.</div><div class="line">     * /    </div><div class="line">    public static void unpark(Thread thread) &#123;</div><div class="line">        if (thread != null)</div><div class="line">            unsafe.unpark(thread);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Disables the current thread for thread scheduling purposes unless the</div><div class="line">     * permit is available.</div><div class="line">     * </div><div class="line">     * the current thread becomes disabled for thread scheduling</div><div class="line">     * purposes and lies dormant until one of three things happens:</div><div class="line">     *</div><div class="line">     * 1. Some other thread invokes &#123;<span class="doctag">@link</span> #unpark unpark&#125; with the</div><div class="line">     * current thread as the target; </div><div class="line">     *</div><div class="line">     * 2. Some other thread &#123;<span class="doctag">@linkplain</span> Thread#interrupt interrupts&#125;</div><div class="line">     * the current thread; </div><div class="line">     *</div><div class="line">     * 3. The call spuriously (that is, for no reason) returns.</div><div class="line">     * /</div><div class="line">    public static void park(Object blocker) &#123;</div><div class="line">        Thread t = Thread.currentThread();</div><div class="line">        setBlocker(t, blocker);</div><div class="line">        unsafe.park(false, 0L); // 线程进入休眠状态，unpark被调用之后，继续向下执行</div><div class="line">        setBlocker(t, null);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static void parkNanos(Object blocker, long nanos) &#123;</div><div class="line">        if (nanos &gt; 0) &#123;</div><div class="line">            Thread t = Thread.currentThread();</div><div class="line">            setBlocker(t, blocker);</div><div class="line">            unsafe.park(false, nanos);</div><div class="line">            setBlocker(t, null);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static void parkUntil(Object blocker, long deadline) &#123;</div><div class="line">        Thread t = Thread.currentThread();</div><div class="line">        setBlocker(t, blocker);</div><div class="line">        unsafe.park(true, deadline);</div><div class="line">        setBlocker(t, null);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static void park() &#123;</div><div class="line">        unsafe.park(false, 0L);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static void parkNanos(long nanos) &#123;</div><div class="line">        if (nanos &gt; 0)</div><div class="line">            unsafe.park(false, nanos);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static void parkUntil(long deadline) &#123;</div><div class="line">        unsafe.park(true, deadline);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>example:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> Thread t;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == t) &#123;</div><div class="line">        t = <span class="keyword">new</span> Thread() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                Log.e(<span class="string">"TAG"</span>, <span class="string">"before park: "</span> + System.currentTimeMillis());</div><div class="line">                LockSupport.park(o);</div><div class="line">                Log.e(<span class="string">"TAG"</span>, <span class="string">"after park: "</span> + System.currentTimeMillis());</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">        t.start();</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        t.interrupt(); </div><div class="line">        <span class="comment">// or LockSupport.unpark(t);</span></div><div class="line">        t = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="CAS操作"><a href="#CAS操作" class="headerlink" title="CAS操作"></a>CAS操作</h2><p>通过<strong>compareAndSwapInt/Long/Object</strong>实现CAS操作；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* 比较obj的offset处内存位置中的值和期望的值，如果相同则更新。此更新是不可中断的。</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> obj 需要更新的对象</div><div class="line">* <span class="doctag">@param</span> offset obj中整型field的偏移量</div><div class="line">* <span class="doctag">@param</span> expect 希望field中存在的值</div><div class="line">* <span class="doctag">@param</span> update 如果期望值expect与field的当前值相同，设置filed的值为这个新值</div><div class="line">* <span class="doctag">@return</span> 如果field的值被更改返回true</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">boolean</span> <span class="title">compareAndSwapInt</span><span class="params">(Object obj, <span class="keyword">long</span> offset, <span class="keyword">int</span> expect, <span class="keyword">int</span> update)</span></span>;</div></pre></td></tr></table></figure>
<p>什么是Compare And Swap(CAS)？简单的说就是比较并交换。</p>
<p>CAS 操作包含三个操作数 —— 内存位置（V）、预期原值（A）和新值(B)。如果内存位置的值与预期原值相匹配，那么处理器会自动将该位置值更新为新值。否则，处理器不做任何操作。无论哪种情况，它都会在 CAS 指令之前返回该位置的值。CAS 有效地说明了“我认为位置 V 应该包含值 A；如果包含该值，则将 B 放到这个位置；否则，不要更改该位置，只告诉我这个位置现在的值即可。” Java并发包(java.util.concurrent)中大量使用了CAS操作,涉及到并发的地方都调用了sun.misc.Unsafe类方法进行CAS操作。</p>
<p>再看一下volatile, Volatile修饰的成员变量在每次被线程访问时，都强迫从共享内存中重读该成员变量的值。而且，当成员变量发生变化时，强迫线程将变化值回写到共享内存。这样在任何时刻，两个不同的线程总是看到某个成员变量的值是相同的，更简单一点理解就是volatile修饰的变量值发生变化时对于另外的线程是可见的。</p>
<h2 id="Unsafe源码"><a href="#Unsafe源码" class="headerlink" title="Unsafe源码"></a>Unsafe源码</h2><p>Unsafe类提供了硬件级别的原子操作，Java无法直接访问到操作系统底层（如系统硬件等)，为此Java使用native方法来扩展Java程序的功能。具体实现使用c++,详见文件sun.misc.natUnsafe.cc();</p>
<h4 id="Unsafe-java"><a href="#Unsafe-java" class="headerlink" title="Unsafe.java"></a><strong>Unsafe.java</strong></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//下面是sun.misc.Unsafe.java类源码</span></div><div class="line"><span class="keyword">package</span> sun.misc;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.Field;</div><div class="line"><span class="comment">/***</span></div><div class="line"> * This class should provide access to low-level operations and its</div><div class="line"> * use should be limited to trusted code.  Fields can be accessed using</div><div class="line"> * memory addresses, with undefined behaviour occurring if invalid memory</div><div class="line"> * addresses are given.</div><div class="line"> * 这个类提供了一个更底层的操作并且应该在受信任的代码中使用。可以通过内存地址</div><div class="line"> * 存取fields,如果给出的内存地址是无效的那么会有一个不确定的运行表现。</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Unsafe</span></span></div><div class="line">&#123;</div><div class="line">  <span class="comment">// Singleton class.</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> Unsafe unsafe = <span class="keyword">new</span> Unsafe();</div><div class="line">  <span class="comment">/***</span></div><div class="line">   * Private default constructor to prevent creation of an arbitrary</div><div class="line">   * number of instances.</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="title">Unsafe</span><span class="params">()</span></span></div><div class="line">  &#123;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">/***</span></div><div class="line">   * Retrieve the singleton instance of &lt;code&gt;Unsafe&lt;/code&gt;.  The calling</div><div class="line">   * method should guard this instance from untrusted code, as it provides</div><div class="line">   * access to low-level operations such as direct memory access.</div><div class="line">   * 获取&lt;code&gt;Unsafe&lt;/code&gt;的单例,这个方法调用应该防止在不可信的代码中实例，</div><div class="line">   * 因为unsafe类提供了一个低级别的操作，例如直接内存存取。</div><div class="line">   * </div><div class="line">   * <span class="doctag">@throws</span> SecurityException if a security manager exists and prevents</div><div class="line">   *                           access to the system properties.</div><div class="line">   *                           如果安全管理器不存在或者禁止访问系统属性</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Unsafe <span class="title">getUnsafe</span><span class="params">()</span></span></div><div class="line">  &#123;</div><div class="line">    SecurityManager sm = System.getSecurityManager();</div><div class="line">    <span class="keyword">if</span> (sm != <span class="keyword">null</span>)</div><div class="line">      sm.checkPropertiesAccess();</div><div class="line">    <span class="keyword">return</span> unsafe;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="comment">/***</span></div><div class="line">   * Returns the memory address offset of the given static field.</div><div class="line">   * The offset is merely used as a means to access a particular field</div><div class="line">   * in the other methods of this class.  The value is unique to the given</div><div class="line">   * field and the same value should be returned on each subsequent call.</div><div class="line">   * 返回指定静态field的内存地址偏移量,在这个类的其他方法中这个值只是被用作一个访问</div><div class="line">   * 特定field的一个方式。这个值对于 给定的field是唯一的，并且后续对该方法的调用都应该</div><div class="line">   * 返回相同的值。</div><div class="line">   *</div><div class="line">   * <span class="doctag">@param</span> field the field whose offset should be returned.</div><div class="line">   *              需要返回偏移量的field</div><div class="line">   * <span class="doctag">@return</span> the offset of the given field.</div><div class="line">   *         指定field的偏移量</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">long</span> <span class="title">objectFieldOffset</span><span class="params">(Field field)</span></span>;</div><div class="line">  <span class="comment">/***</span></div><div class="line">   * Compares the value of the integer field at the specified offset</div><div class="line">   * in the supplied object with the given expected value, and updates</div><div class="line">   * it if they match.  The operation of this method should be atomic,</div><div class="line">   * thus providing an uninterruptible way of updating an integer field.</div><div class="line">   * 在obj的offset位置比较integer field和期望的值，如果相同则更新。这个方法</div><div class="line">   * 的操作应该是原子的，因此提供了一种不可中断的方式更新integer field。</div><div class="line">   * </div><div class="line">   * <span class="doctag">@param</span> obj the object containing the field to modify.</div><div class="line">   *            包含要修改field的对象</div><div class="line">   * <span class="doctag">@param</span> offset the offset of the integer field within &lt;code&gt;obj&lt;/code&gt;.</div><div class="line">   *               &lt;code&gt;obj&lt;/code&gt;中整型field的偏移量</div><div class="line">   * <span class="doctag">@param</span> expect the expected value of the field.</div><div class="line">   *               希望field中存在的值</div><div class="line">   * <span class="doctag">@param</span> update the new value of the field if it equals &lt;code&gt;expect&lt;/code&gt;.</div><div class="line">   *           如果期望值expect与field的当前值相同，设置filed的值为这个新值</div><div class="line">   * <span class="doctag">@return</span> true if the field was changed.</div><div class="line">   *                             如果field的值被更改</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">boolean</span> <span class="title">compareAndSwapInt</span><span class="params">(Object obj, <span class="keyword">long</span> offset,</span></span></div><div class="line">                                          <span class="keyword">int</span> expect, <span class="keyword">int</span> update);</div><div class="line">  <span class="comment">/***</span></div><div class="line">   * Compares the value of the long field at the specified offset</div><div class="line">   * in the supplied object with the given expected value, and updates</div><div class="line">   * it if they match.  The operation of this method should be atomic,</div><div class="line">   * thus providing an uninterruptible way of updating a long field.</div><div class="line">   * 在obj的offset位置比较long field和期望的值，如果相同则更新。这个方法</div><div class="line">   * 的操作应该是原子的，因此提供了一种不可中断的方式更新long field。</div><div class="line">   * </div><div class="line">   * <span class="doctag">@param</span> obj the object containing the field to modify.</div><div class="line">   *              包含要修改field的对象 </div><div class="line">   * <span class="doctag">@param</span> offset the offset of the long field within &lt;code&gt;obj&lt;/code&gt;.</div><div class="line">   *               &lt;code&gt;obj&lt;/code&gt;中long型field的偏移量</div><div class="line">   * <span class="doctag">@param</span> expect the expected value of the field.</div><div class="line">   *               希望field中存在的值</div><div class="line">   * <span class="doctag">@param</span> update the new value of the field if it equals &lt;code&gt;expect&lt;/code&gt;.</div><div class="line">   *               如果期望值expect与field的当前值相同，设置filed的值为这个新值</div><div class="line">   * <span class="doctag">@return</span> true if the field was changed.</div><div class="line">   *              如果field的值被更改</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">boolean</span> <span class="title">compareAndSwapLong</span><span class="params">(Object obj, <span class="keyword">long</span> offset,</span></span></div><div class="line">                                           <span class="keyword">long</span> expect, <span class="keyword">long</span> update);</div><div class="line">  <span class="comment">/***</span></div><div class="line">   * Compares the value of the object field at the specified offset</div><div class="line">   * in the supplied object with the given expected value, and updates</div><div class="line">   * it if they match.  The operation of this method should be atomic,</div><div class="line">   * thus providing an uninterruptible way of updating an object field.</div><div class="line">   * 在obj的offset位置比较object field和期望的值，如果相同则更新。这个方法</div><div class="line">   * 的操作应该是原子的，因此提供了一种不可中断的方式更新object field。</div><div class="line">   * </div><div class="line">   * <span class="doctag">@param</span> obj the object containing the field to modify.</div><div class="line">   *    包含要修改field的对象 </div><div class="line">   * <span class="doctag">@param</span> offset the offset of the object field within &lt;code&gt;obj&lt;/code&gt;.</div><div class="line">   *         &lt;code&gt;obj&lt;/code&gt;中object型field的偏移量</div><div class="line">   * <span class="doctag">@param</span> expect the expected value of the field.</div><div class="line">   *               希望field中存在的值</div><div class="line">   * <span class="doctag">@param</span> update the new value of the field if it equals &lt;code&gt;expect&lt;/code&gt;.</div><div class="line">   *               如果期望值expect与field的当前值相同，设置filed的值为这个新值</div><div class="line">   * <span class="doctag">@return</span> true if the field was changed.</div><div class="line">   *              如果field的值被更改</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">boolean</span> <span class="title">compareAndSwapObject</span><span class="params">(Object obj, <span class="keyword">long</span> offset,</span></span></div><div class="line">                                             Object expect, Object update);</div><div class="line">  <span class="comment">/***</span></div><div class="line">   * Sets the value of the integer field at the specified offset in the</div><div class="line">   * supplied object to the given value.  This is an ordered or lazy</div><div class="line">   * version of &lt;code&gt;putIntVolatile(Object,long,int)&lt;/code&gt;, which</div><div class="line">   * doesn't guarantee the immediate visibility of the change to other</div><div class="line">   * threads.  It is only really useful where the integer field is</div><div class="line">   * &lt;code&gt;volatile&lt;/code&gt;, and is thus expected to change unexpectedly.</div><div class="line">   * 设置obj对象中offset偏移地址对应的整型field的值为指定值。这是一个有序或者</div><div class="line">   * 有延迟的&lt;code&gt;putIntVolatile&lt;/cdoe&gt;方法，并且不保证值的改变被其他线程立</div><div class="line">   * 即看到。只有在field被&lt;code&gt;volatile&lt;/code&gt;修饰并且期望被意外修改的时候</div><div class="line">   * 使用才有用。</div><div class="line">   * </div><div class="line">   * <span class="doctag">@param</span> obj the object containing the field to modify.</div><div class="line">   *    包含需要修改field的对象</div><div class="line">   * <span class="doctag">@param</span> offset the offset of the integer field within &lt;code&gt;obj&lt;/code&gt;.</div><div class="line">   *       &lt;code&gt;obj&lt;/code&gt;中整型field的偏移量</div><div class="line">   * <span class="doctag">@param</span> value the new value of the field.</div><div class="line">   *      field将被设置的新值</div><div class="line">   * <span class="doctag">@see</span> #putIntVolatile(Object,long,int)</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">putOrderedInt</span><span class="params">(Object obj, <span class="keyword">long</span> offset, <span class="keyword">int</span> value)</span></span>;</div><div class="line">  <span class="comment">/***</span></div><div class="line">   * Sets the value of the long field at the specified offset in the</div><div class="line">   * supplied object to the given value.  This is an ordered or lazy</div><div class="line">   * version of &lt;code&gt;putLongVolatile(Object,long,long)&lt;/code&gt;, which</div><div class="line">   * doesn't guarantee the immediate visibility of the change to other</div><div class="line">   * threads.  It is only really useful where the long field is</div><div class="line">   * &lt;code&gt;volatile&lt;/code&gt;, and is thus expected to change unexpectedly.</div><div class="line">   * 设置obj对象中offset偏移地址对应的long型field的值为指定值。这是一个有序或者</div><div class="line">   * 有延迟的&lt;code&gt;putLongVolatile&lt;/cdoe&gt;方法，并且不保证值的改变被其他线程立</div><div class="line">   * 即看到。只有在field被&lt;code&gt;volatile&lt;/code&gt;修饰并且期望被意外修改的时候</div><div class="line">   * 使用才有用。</div><div class="line">   * </div><div class="line">   * <span class="doctag">@param</span> obj the object containing the field to modify.</div><div class="line">   *    包含需要修改field的对象</div><div class="line">   * <span class="doctag">@param</span> offset the offset of the long field within &lt;code&gt;obj&lt;/code&gt;.</div><div class="line">   *       &lt;code&gt;obj&lt;/code&gt;中long型field的偏移量</div><div class="line">   * <span class="doctag">@param</span> value the new value of the field.</div><div class="line">   *      field将被设置的新值</div><div class="line">   * <span class="doctag">@see</span> #putLongVolatile(Object,long,long)</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">putOrderedLong</span><span class="params">(Object obj, <span class="keyword">long</span> offset, <span class="keyword">long</span> value)</span></span>;</div><div class="line">  <span class="comment">/***</span></div><div class="line">   * Sets the value of the object field at the specified offset in the</div><div class="line">   * supplied object to the given value.  This is an ordered or lazy</div><div class="line">   * version of &lt;code&gt;putObjectVolatile(Object,long,Object)&lt;/code&gt;, which</div><div class="line">   * doesn't guarantee the immediate visibility of the change to other</div><div class="line">   * threads.  It is only really useful where the object field is</div><div class="line">   * &lt;code&gt;volatile&lt;/code&gt;, and is thus expected to change unexpectedly.</div><div class="line">   * 设置obj对象中offset偏移地址对应的object型field的值为指定值。这是一个有序或者</div><div class="line">   * 有延迟的&lt;code&gt;putObjectVolatile&lt;/cdoe&gt;方法，并且不保证值的改变被其他线程立</div><div class="line">   * 即看到。只有在field被&lt;code&gt;volatile&lt;/code&gt;修饰并且期望被意外修改的时候</div><div class="line">   * 使用才有用。</div><div class="line">   *</div><div class="line">   * <span class="doctag">@param</span> obj the object containing the field to modify.</div><div class="line">   *    包含需要修改field的对象</div><div class="line">   * <span class="doctag">@param</span> offset the offset of the object field within &lt;code&gt;obj&lt;/code&gt;.</div><div class="line">   *       &lt;code&gt;obj&lt;/code&gt;中long型field的偏移量</div><div class="line">   * <span class="doctag">@param</span> value the new value of the field.</div><div class="line">   *      field将被设置的新值</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">putOrderedObject</span><span class="params">(Object obj, <span class="keyword">long</span> offset, Object value)</span></span>;</div><div class="line">  <span class="comment">/***</span></div><div class="line">   * Sets the value of the integer field at the specified offset in the</div><div class="line">   * supplied object to the given value, with volatile store semantics.</div><div class="line">   * 设置obj对象中offset偏移地址对应的整型field的值为指定值。支持volatile store语义</div><div class="line">   * </div><div class="line">   * <span class="doctag">@param</span> obj the object containing the field to modify.</div><div class="line">   *    包含需要修改field的对象</div><div class="line">   * <span class="doctag">@param</span> offset the offset of the integer field within &lt;code&gt;obj&lt;/code&gt;.</div><div class="line">   *       &lt;code&gt;obj&lt;/code&gt;中整型field的偏移量</div><div class="line">   * <span class="doctag">@param</span> value the new value of the field.</div><div class="line">   *       field将被设置的新值</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">putIntVolatile</span><span class="params">(Object obj, <span class="keyword">long</span> offset, <span class="keyword">int</span> value)</span></span>;</div><div class="line">  <span class="comment">/***</span></div><div class="line">   * Retrieves the value of the integer field at the specified offset in the</div><div class="line">   * supplied object with volatile load semantics.</div><div class="line">   * 获取obj对象中offset偏移地址对应的整型field的值,支持volatile load语义。</div><div class="line">   * </div><div class="line">   * <span class="doctag">@param</span> obj the object containing the field to read.</div><div class="line">   *    包含需要去读取的field的对象</div><div class="line">   * <span class="doctag">@param</span> offset the offset of the integer field within &lt;code&gt;obj&lt;/code&gt;.</div><div class="line">   *       &lt;code&gt;obj&lt;/code&gt;中整型field的偏移量</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">getIntVolatile</span><span class="params">(Object obj, <span class="keyword">long</span> offset)</span></span>;</div><div class="line">  <span class="comment">/***</span></div><div class="line">   * Sets the value of the long field at the specified offset in the</div><div class="line">   * supplied object to the given value, with volatile store semantics.</div><div class="line">   * 设置obj对象中offset偏移地址对应的long型field的值为指定值。支持volatile store语义</div><div class="line">   *</div><div class="line">   * <span class="doctag">@param</span> obj the object containing the field to modify.</div><div class="line">   *            包含需要修改field的对象</div><div class="line">   * <span class="doctag">@param</span> offset the offset of the long field within &lt;code&gt;obj&lt;/code&gt;.</div><div class="line">   *               &lt;code&gt;obj&lt;/code&gt;中long型field的偏移量</div><div class="line">   * <span class="doctag">@param</span> value the new value of the field.</div><div class="line">   *              field将被设置的新值</div><div class="line">   * <span class="doctag">@see</span> #putLong(Object,long,long)</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">putLongVolatile</span><span class="params">(Object obj, <span class="keyword">long</span> offset, <span class="keyword">long</span> value)</span></span>;</div><div class="line">  <span class="comment">/***</span></div><div class="line">   * Sets the value of the long field at the specified offset in the</div><div class="line">   * supplied object to the given value.</div><div class="line">   * 设置obj对象中offset偏移地址对应的long型field的值为指定值。</div><div class="line">   * </div><div class="line">   * <span class="doctag">@param</span> obj the object containing the field to modify.</div><div class="line">   *     包含需要修改field的对象</div><div class="line">   * <span class="doctag">@param</span> offset the offset of the long field within &lt;code&gt;obj&lt;/code&gt;.</div><div class="line">   *     &lt;code&gt;obj&lt;/code&gt;中long型field的偏移量</div><div class="line">   * <span class="doctag">@param</span> value the new value of the field.</div><div class="line">   *     field将被设置的新值</div><div class="line">   * <span class="doctag">@see</span> #putLongVolatile(Object,long,long)</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">putLong</span><span class="params">(Object obj, <span class="keyword">long</span> offset, <span class="keyword">long</span> value)</span></span>;</div><div class="line">  <span class="comment">/***</span></div><div class="line">   * Retrieves the value of the long field at the specified offset in the</div><div class="line">   * supplied object with volatile load semantics.</div><div class="line">   * 获取obj对象中offset偏移地址对应的long型field的值,支持volatile load语义。</div><div class="line">   * </div><div class="line">   * <span class="doctag">@param</span> obj the object containing the field to read.</div><div class="line">   *    包含需要去读取的field的对象</div><div class="line">   * <span class="doctag">@param</span> offset the offset of the long field within &lt;code&gt;obj&lt;/code&gt;.</div><div class="line">   *       &lt;code&gt;obj&lt;/code&gt;中long型field的偏移量</div><div class="line">   * <span class="doctag">@see</span> #getLong(Object,long)</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">long</span> <span class="title">getLongVolatile</span><span class="params">(Object obj, <span class="keyword">long</span> offset)</span></span>;</div><div class="line">  <span class="comment">/***</span></div><div class="line">   * Retrieves the value of the long field at the specified offset in the</div><div class="line">   * supplied object.</div><div class="line">   * 获取obj对象中offset偏移地址对应的long型field的值</div><div class="line">   * </div><div class="line">   * <span class="doctag">@param</span> obj the object containing the field to read.</div><div class="line">   *    包含需要去读取的field的对象</div><div class="line">   * <span class="doctag">@param</span> offset the offset of the long field within &lt;code&gt;obj&lt;/code&gt;.</div><div class="line">   *       &lt;code&gt;obj&lt;/code&gt;中long型field的偏移量</div><div class="line">   * <span class="doctag">@see</span> #getLongVolatile(Object,long)</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">long</span> <span class="title">getLong</span><span class="params">(Object obj, <span class="keyword">long</span> offset)</span></span>;</div><div class="line">  <span class="comment">/***</span></div><div class="line">   * Sets the value of the object field at the specified offset in the</div><div class="line">   * supplied object to the given value, with volatile store semantics.</div><div class="line">   * 设置obj对象中offset偏移地址对应的object型field的值为指定值。支持volatile store语义</div><div class="line">   * </div><div class="line">   * <span class="doctag">@param</span> obj the object containing the field to modify.</div><div class="line">   *    包含需要修改field的对象</div><div class="line">   * <span class="doctag">@param</span> offset the offset of the object field within &lt;code&gt;obj&lt;/code&gt;.</div><div class="line">   *     &lt;code&gt;obj&lt;/code&gt;中object型field的偏移量</div><div class="line">   * <span class="doctag">@param</span> value the new value of the field.</div><div class="line">   *       field将被设置的新值</div><div class="line">   * <span class="doctag">@see</span> #putObject(Object,long,Object)</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">putObjectVolatile</span><span class="params">(Object obj, <span class="keyword">long</span> offset, Object value)</span></span>;</div><div class="line">  <span class="comment">/***</span></div><div class="line">   * Sets the value of the object field at the specified offset in the</div><div class="line">   * supplied object to the given value.</div><div class="line">   * 设置obj对象中offset偏移地址对应的object型field的值为指定值。</div><div class="line">   * </div><div class="line">   * <span class="doctag">@param</span> obj the object containing the field to modify.</div><div class="line">   *    包含需要修改field的对象</div><div class="line">   * <span class="doctag">@param</span> offset the offset of the object field within &lt;code&gt;obj&lt;/code&gt;.</div><div class="line">   *     &lt;code&gt;obj&lt;/code&gt;中object型field的偏移量</div><div class="line">   * <span class="doctag">@param</span> value the new value of the field.</div><div class="line">   *       field将被设置的新值</div><div class="line">   * <span class="doctag">@see</span> #putObjectVolatile(Object,long,Object)</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">putObject</span><span class="params">(Object obj, <span class="keyword">long</span> offset, Object value)</span></span>;</div><div class="line">  <span class="comment">/***</span></div><div class="line">   * Retrieves the value of the object field at the specified offset in the</div><div class="line">   * supplied object with volatile load semantics.</div><div class="line">   * 获取obj对象中offset偏移地址对应的object型field的值,支持volatile load语义。</div><div class="line">   * </div><div class="line">   * <span class="doctag">@param</span> obj the object containing the field to read.</div><div class="line">   *    包含需要去读取的field的对象</div><div class="line">   * <span class="doctag">@param</span> offset the offset of the object field within &lt;code&gt;obj&lt;/code&gt;.</div><div class="line">   *       &lt;code&gt;obj&lt;/code&gt;中object型field的偏移量</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> Object <span class="title">getObjectVolatile</span><span class="params">(Object obj, <span class="keyword">long</span> offset)</span></span>;</div><div class="line">  <span class="comment">/***</span></div><div class="line">   * Returns the offset of the first element for a given array class.</div><div class="line">   * To access elements of the array class, this value may be used along with</div><div class="line">   * with that returned by </div><div class="line">   * &lt;a href="#arrayIndexScale"&gt;&lt;code&gt;arrayIndexScale&lt;/code&gt;&lt;/a&gt;,</div><div class="line">   * if non-zero.</div><div class="line">   * 获取给定数组中第一个元素的偏移地址。</div><div class="line">   * 为了存取数组中的元素，这个偏移地址与&lt;a href="#arrayIndexScale"&gt;&lt;code&gt;arrayIndexScale</div><div class="line">   * &lt;/code&gt;&lt;/a&gt;方法的非0返回值一起被使用。</div><div class="line">   * <span class="doctag">@param</span> arrayClass the class for which the first element's address should</div><div class="line">   *                   be obtained.</div><div class="line">   *                   第一个元素地址被获取的class</div><div class="line">   * <span class="doctag">@return</span> the offset of the first element of the array class.</div><div class="line">   *    数组第一个元素 的偏移地址</div><div class="line">   * <span class="doctag">@see</span> arrayIndexScale(Class)</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">arrayBaseOffset</span><span class="params">(Class arrayClass)</span></span>;</div><div class="line">  <span class="comment">/***</span></div><div class="line">   * Returns the scale factor used for addressing elements of the supplied</div><div class="line">   * array class.  Where a suitable scale factor can not be returned (e.g.</div><div class="line">   * for primitive types), zero should be returned.  The returned value</div><div class="line">   * can be used with </div><div class="line">   * &lt;a href="#arrayBaseOffset"&gt;&lt;code&gt;arrayBaseOffset&lt;/code&gt;&lt;/a&gt;</div><div class="line">   * to access elements of the class.</div><div class="line">   * 获取用户给定数组寻址的换算因子.一个合适的换算因子不能返回的时候(例如：基本类型),</div><div class="line">   * 返回0.这个返回值能够与&lt;a href="#arrayBaseOffset"&gt;&lt;code&gt;arrayBaseOffset&lt;/code&gt;</div><div class="line">   * &lt;/a&gt;一起使用去存取这个数组class中的元素</div><div class="line">   * </div><div class="line">   * <span class="doctag">@param</span> arrayClass the class whose scale factor should be returned.</div><div class="line">   * <span class="doctag">@return</span> the scale factor, or zero if not supported for this array class.</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">arrayIndexScale</span><span class="params">(Class arrayClass)</span></span>;</div><div class="line">  </div><div class="line">  <span class="comment">/***</span></div><div class="line">   * Releases the block on a thread created by </div><div class="line">   * &lt;a href="#park"&gt;&lt;code&gt;park&lt;/code&gt;&lt;/a&gt;.  This method can also be used</div><div class="line">   * to terminate a blockage caused by a prior call to &lt;code&gt;park&lt;/code&gt;.</div><div class="line">   * This operation is unsafe, as the thread must be guaranteed to be</div><div class="line">   * live.  This is true of Java, but not native code.</div><div class="line">   * 释放被&lt;a href="#park"&gt;&lt;code&gt;park&lt;/code&gt;&lt;/a&gt;创建的在一个线程上的阻塞.这个</div><div class="line">   * 方法也可以被使用来终止一个先前调用&lt;code&gt;park&lt;/code&gt;导致的阻塞.</div><div class="line">   * 这个操作操作时不安全的,因此线程必须保证是活的.这是java代码不是native代码。</div><div class="line">   * <span class="doctag">@param</span> thread the thread to unblock.</div><div class="line">   *           要解除阻塞的线程</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">unpark</span><span class="params">(Thread thread)</span></span>;</div><div class="line">  <span class="comment">/***</span></div><div class="line">   * Blocks the thread until a matching </div><div class="line">   * &lt;a href="#unpark"&gt;&lt;code&gt;unpark&lt;/code&gt;&lt;/a&gt; occurs, the thread is</div><div class="line">   * interrupted or the optional timeout expires.  If an &lt;code&gt;unpark&lt;/code&gt;</div><div class="line">   * call has already occurred, this also counts.  A timeout value of zero</div><div class="line">   * is defined as no timeout.  When &lt;code&gt;isAbsolute&lt;/code&gt; is</div><div class="line">   * &lt;code&gt;true&lt;/code&gt;, the timeout is in milliseconds relative to the</div><div class="line">   * epoch.  Otherwise, the value is the number of nanoseconds which must</div><div class="line">   * occur before timeout.  This call may also return spuriously (i.e.</div><div class="line">   * for no apparent reason).</div><div class="line">   * 阻塞一个线程直到&lt;a href="#unpark"&gt;&lt;code&gt;unpark&lt;/code&gt;&lt;/a&gt;出现、线程</div><div class="line">   * 被中断或者timeout时间到期。如果一个&lt;code&gt;unpark&lt;/code&gt;调用已经出现了，</div><div class="line">   * 这里只计数。timeout为0表示永不过期.当&lt;code&gt;isAbsolute&lt;/code&gt;为true时，</div><div class="line">   * timeout是相对于新纪元之后的毫秒。否则这个值就是超时前的纳秒数。这个方法执行时</div><div class="line">   * 也可能不合理地返回(没有具体原因)</div><div class="line">   * </div><div class="line">   * <span class="doctag">@param</span> isAbsolute true if the timeout is specified in milliseconds from</div><div class="line">   *                   the epoch.</div><div class="line">   *                   如果为true timeout的值是一个相对于新纪元之后的毫秒数</div><div class="line">   * <span class="doctag">@param</span> time either the number of nanoseconds to wait, or a time in</div><div class="line">   *             milliseconds from the epoch to wait for.</div><div class="line">   *             可以是一个要等待的纳秒数，或者是一个相对于新纪元之后的毫秒数直到</div><div class="line">   *             到达这个时间点</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">park</span><span class="params">(<span class="keyword">boolean</span> isAbsolute, <span class="keyword">long</span> time)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Unsafe-h"><a href="#Unsafe-h" class="headerlink" title="Unsafe.h"></a><strong>Unsafe.h</strong></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line">// DO NOT EDIT THIS FILE - it is machine generated -*- c++ -*-</div><div class="line"></div><div class="line">#ifndef __sun_misc_Unsafe__</div><div class="line">#define __sun_misc_Unsafe__</div><div class="line"></div><div class="line">#pragma interface</div><div class="line"></div><div class="line">#include &lt;java/lang/Object.h&gt;</div><div class="line">extern &quot;Java&quot;</div><div class="line">&#123;</div><div class="line">  namespace sun</div><div class="line">  &#123;</div><div class="line">    namespace misc</div><div class="line">    &#123;</div><div class="line">        class Unsafe;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">class sun::misc::Unsafe : public ::java::lang::Object</div><div class="line">&#123;</div><div class="line"></div><div class="line">  Unsafe();</div><div class="line">public:</div><div class="line">  static ::sun::misc::Unsafe * getUnsafe();</div><div class="line">  virtual jlong objectFieldOffset(::java::lang::reflect::Field *);</div><div class="line">  virtual jboolean compareAndSwapInt(::java::lang::Object *, jlong, jint, jint);</div><div class="line">  virtual jboolean compareAndSwapLong(::java::lang::Object *, jlong, jlong, jlong);</div><div class="line">  virtual jboolean compareAndSwapObject(::java::lang::Object *, jlong, ::java::lang::Object *, ::java::lang::Object *);</div><div class="line">  virtual void putOrderedInt(::java::lang::Object *, jlong, jint);</div><div class="line">  virtual void putOrderedLong(::java::lang::Object *, jlong, jlong);</div><div class="line">  virtual void putOrderedObject(::java::lang::Object *, jlong, ::java::lang::Object *);</div><div class="line">  virtual void putIntVolatile(::java::lang::Object *, jlong, jint);</div><div class="line">  virtual jint getIntVolatile(::java::lang::Object *, jlong);</div><div class="line">  virtual void putLongVolatile(::java::lang::Object *, jlong, jlong);</div><div class="line">  virtual void putLong(::java::lang::Object *, jlong, jlong);</div><div class="line">  virtual jlong getLongVolatile(::java::lang::Object *, jlong);</div><div class="line">  virtual jlong getLong(::java::lang::Object *, jlong);</div><div class="line">  virtual void putObjectVolatile(::java::lang::Object *, jlong, ::java::lang::Object *);</div><div class="line">  virtual void putObject(::java::lang::Object *, jlong, ::java::lang::Object *);</div><div class="line">  virtual ::java::lang::Object * getObjectVolatile(::java::lang::Object *, jlong);</div><div class="line">  virtual jint arrayBaseOffset(::java::lang::Class *);</div><div class="line">  virtual jint arrayIndexScale(::java::lang::Class *);</div><div class="line">  virtual void unpark(::java::lang::Thread *);</div><div class="line">  virtual void park(jboolean, jlong);</div><div class="line">private:</div><div class="line">  static ::sun::misc::Unsafe * unsafe;</div><div class="line">public:</div><div class="line">  static ::java::lang::Class class$;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">#endif // __sun_misc_Unsafe__</div></pre></td></tr></table></figure>
<h4 id="natUnsafe-cc"><a href="#natUnsafe-cc" class="headerlink" title="natUnsafe.cc"></a><strong>natUnsafe.cc</strong></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div></pre></td><td class="code"><pre><div class="line">// natUnsafe.cc - Implementation of sun.misc.Unsafe native methods.</div><div class="line"></div><div class="line">/** Copyright (C) 2006, 2007</div><div class="line">   Free Software Foundation</div><div class="line"></div><div class="line">   This file is part of libgcj.</div><div class="line"></div><div class="line">This software is copyrighted work licensed under the terms of the</div><div class="line">Libgcj License.  Please consult the file &quot;LIBGCJ_LICENSE&quot; for</div><div class="line">details.  */</div><div class="line"></div><div class="line">#include &lt;gcj/cni.h&gt;</div><div class="line">#include &lt;gcj/field.h&gt;</div><div class="line">#include &lt;gcj/javaprims.h&gt;</div><div class="line">#include &lt;jvm.h&gt;</div><div class="line">#include &lt;sun/misc/Unsafe.h&gt;</div><div class="line">#include &lt;java/lang/System.h&gt;</div><div class="line">#include &lt;java/lang/InterruptedException.h&gt;</div><div class="line"></div><div class="line">#include &lt;java/lang/Thread.h&gt;</div><div class="line">#include &lt;java/lang/Long.h&gt;</div><div class="line"></div><div class="line">#include &quot;sysdep/locks.h&quot;</div><div class="line"></div><div class="line">// Use a spinlock for multi-word accesses</div><div class="line">class spinlock</div><div class="line">&#123;</div><div class="line">  static volatile obj_addr_t lock;</div><div class="line"></div><div class="line">public:</div><div class="line"></div><div class="line">spinlock ()</div><div class="line">  &#123;</div><div class="line">    while (! compare_and_swap (&amp;lock, 0, 1))</div><div class="line">      _Jv_ThreadYield ();</div><div class="line">  &#125;</div><div class="line">  ~spinlock ()</div><div class="line">  &#123;</div><div class="line">    release_set (&amp;lock, 0);</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line">  </div><div class="line">// This is a single lock that is used for all synchronized accesses if</div><div class="line">// the compiler can&apos;t generate inline compare-and-swap operations.  In</div><div class="line">// most cases it&apos;ll never be used, but the i386 needs it for 64-bit</div><div class="line">// locked accesses and so does PPC32.  It&apos;s worth building libgcj with</div><div class="line">// target=i486 (or above) to get the inlines.</div><div class="line">volatile obj_addr_t spinlock::lock;</div><div class="line"></div><div class="line"></div><div class="line">static inline bool</div><div class="line">compareAndSwap (volatile jint *addr, jint old, jint new_val)</div><div class="line">&#123;</div><div class="line">  jboolean result = false;</div><div class="line">  spinlock lock;</div><div class="line">  if ((result = (*addr == old)))</div><div class="line">    *addr = new_val;</div><div class="line">  return result;</div><div class="line">&#125;</div><div class="line">  </div><div class="line">static inline bool</div><div class="line">compareAndSwap (volatile jlong *addr, jlong old, jlong new_val)</div><div class="line">&#123;</div><div class="line">  jboolean result = false;</div><div class="line">  spinlock lock;</div><div class="line">  if ((result = (*addr == old)))</div><div class="line">    *addr = new_val;</div><div class="line">  return result;</div><div class="line">&#125;</div><div class="line">  </div><div class="line">static inline bool</div><div class="line">compareAndSwap (volatile jobject *addr, jobject old, jobject new_val)</div><div class="line">&#123;</div><div class="line">  jboolean result = false;</div><div class="line">  spinlock lock;</div><div class="line">  if ((result = (*addr == old)))</div><div class="line">    *addr = new_val;</div><div class="line">  return result;</div><div class="line">&#125;</div><div class="line">  </div><div class="line"></div><div class="line">jlong</div><div class="line">sun::misc::Unsafe::objectFieldOffset (::java::lang::reflect::Field *field)</div><div class="line">&#123;</div><div class="line">  _Jv_Field *fld = _Jv_FromReflectedField (field);</div><div class="line">  // FIXME: what if it is not an instance field?</div><div class="line">  return fld-&gt;getOffset();</div><div class="line">&#125;</div><div class="line"></div><div class="line">jint</div><div class="line">sun::misc::Unsafe::arrayBaseOffset (jclass arrayClass)</div><div class="line">&#123;</div><div class="line">  // FIXME: assert that arrayClass is array.</div><div class="line">  jclass eltClass = arrayClass-&gt;getComponentType();</div><div class="line">  return (jint)(jlong) _Jv_GetArrayElementFromElementType (NULL, eltClass);</div><div class="line">&#125;</div><div class="line"></div><div class="line">jint</div><div class="line">sun::misc::Unsafe::arrayIndexScale (jclass arrayClass)</div><div class="line">&#123;</div><div class="line">  // FIXME: assert that arrayClass is array.</div><div class="line">  jclass eltClass = arrayClass-&gt;getComponentType();</div><div class="line">  if (eltClass-&gt;isPrimitive())</div><div class="line">    return eltClass-&gt;size();</div><div class="line">  return sizeof (void *);</div><div class="line">&#125;</div><div class="line"></div><div class="line">// These methods are used when the compiler fails to generate inline</div><div class="line">// versions of the compare-and-swap primitives.</div><div class="line"></div><div class="line">jboolean</div><div class="line">sun::misc::Unsafe::compareAndSwapInt (jobject obj, jlong offset,</div><div class="line">                      jint expect, jint update)</div><div class="line">&#123;</div><div class="line">  jint *addr = (jint *)((char *)obj + offset);</div><div class="line">  return compareAndSwap (addr, expect, update);</div><div class="line">&#125;</div><div class="line"></div><div class="line">jboolean</div><div class="line">sun::misc::Unsafe::compareAndSwapLong (jobject obj, jlong offset,</div><div class="line">                       jlong expect, jlong update)</div><div class="line">&#123;</div><div class="line">  volatile jlong *addr = (jlong*)((char *) obj + offset);</div><div class="line">  return compareAndSwap (addr, expect, update);</div><div class="line">&#125;</div><div class="line"></div><div class="line">jboolean</div><div class="line">sun::misc::Unsafe::compareAndSwapObject (jobject obj, jlong offset,</div><div class="line">                     jobject expect, jobject update)</div><div class="line">&#123;</div><div class="line">  jobject *addr = (jobject*)((char *) obj + offset);</div><div class="line">  return compareAndSwap (addr, expect, update);</div><div class="line">&#125;</div><div class="line"></div><div class="line">void</div><div class="line">sun::misc::Unsafe::putOrderedInt (jobject obj, jlong offset, jint value)</div><div class="line">&#123;</div><div class="line">  volatile jint *addr = (jint *) ((char *) obj + offset);</div><div class="line">  *addr = value;</div><div class="line">&#125;</div><div class="line"></div><div class="line">void</div><div class="line">sun::misc::Unsafe::putOrderedLong (jobject obj, jlong offset, jlong value)</div><div class="line">&#123;</div><div class="line">  volatile jlong *addr = (jlong *) ((char *) obj + offset);</div><div class="line">  spinlock lock;</div><div class="line">  *addr = value;</div><div class="line">&#125;</div><div class="line"></div><div class="line">void</div><div class="line">sun::misc::Unsafe::putOrderedObject (jobject obj, jlong offset, jobject value)</div><div class="line">&#123;</div><div class="line">  volatile jobject *addr = (jobject *) ((char *) obj + offset);</div><div class="line">  *addr = value;</div><div class="line">&#125;</div><div class="line"></div><div class="line">void</div><div class="line">sun::misc::Unsafe::putIntVolatile (jobject obj, jlong offset, jint value)</div><div class="line">&#123;</div><div class="line">  write_barrier ();</div><div class="line">  volatile jint *addr = (jint *) ((char *) obj + offset);</div><div class="line">  *addr = value;</div><div class="line">&#125;</div><div class="line"></div><div class="line">void</div><div class="line">sun::misc::Unsafe::putLongVolatile (jobject obj, jlong offset, jlong value)</div><div class="line">&#123;</div><div class="line">  volatile jlong *addr = (jlong *) ((char *) obj + offset);</div><div class="line">  spinlock lock;</div><div class="line">  *addr = value;</div><div class="line">&#125;</div><div class="line"></div><div class="line">void</div><div class="line">sun::misc::Unsafe::putObjectVolatile (jobject obj, jlong offset, jobject value)</div><div class="line">&#123;</div><div class="line">  write_barrier ();</div><div class="line">  volatile jobject *addr = (jobject *) ((char *) obj + offset);</div><div class="line">  *addr = value;</div><div class="line">&#125;</div><div class="line"></div><div class="line">#if 0  // FIXME</div><div class="line">void</div><div class="line">sun::misc::Unsafe::putInt (jobject obj, jlong offset, jint value)</div><div class="line">&#123;</div><div class="line">  jint *addr = (jint *) ((char *) obj + offset);</div><div class="line">  *addr = value;</div><div class="line">&#125;</div><div class="line">#endif</div><div class="line"></div><div class="line">void</div><div class="line">sun::misc::Unsafe::putLong (jobject obj, jlong offset, jlong value)</div><div class="line">&#123;</div><div class="line">  jlong *addr = (jlong *) ((char *) obj + offset);</div><div class="line">  spinlock lock;</div><div class="line">  *addr = value;</div><div class="line">&#125;</div><div class="line"></div><div class="line">void</div><div class="line">sun::misc::Unsafe::putObject (jobject obj, jlong offset, jobject value)</div><div class="line">&#123;</div><div class="line">  jobject *addr = (jobject *) ((char *) obj + offset);</div><div class="line">  *addr = value;</div><div class="line">&#125;</div><div class="line"></div><div class="line">jint</div><div class="line">sun::misc::Unsafe::getIntVolatile (jobject obj, jlong offset)</div><div class="line">&#123;</div><div class="line">  volatile jint *addr = (jint *) ((char *) obj + offset);</div><div class="line">  jint result = *addr;</div><div class="line">  read_barrier ();</div><div class="line">  return result;</div><div class="line">&#125;</div><div class="line"></div><div class="line">jobject</div><div class="line">sun::misc::Unsafe::getObjectVolatile (jobject obj, jlong offset)</div><div class="line">&#123;</div><div class="line">  volatile jobject *addr = (jobject *) ((char *) obj + offset);</div><div class="line">  jobject result = *addr;</div><div class="line">  read_barrier ();</div><div class="line">  return result;</div><div class="line">&#125;</div><div class="line"></div><div class="line">jlong</div><div class="line">sun::misc::Unsafe::getLong (jobject obj, jlong offset)</div><div class="line">&#123;</div><div class="line">  jlong *addr = (jlong *) ((char *) obj + offset);</div><div class="line">  spinlock lock;</div><div class="line">  return *addr;</div><div class="line">&#125;</div><div class="line"></div><div class="line">jlong</div><div class="line">sun::misc::Unsafe::getLongVolatile (jobject obj, jlong offset)</div><div class="line">&#123;</div><div class="line">  volatile jlong *addr = (jlong *) ((char *) obj + offset);</div><div class="line">  spinlock lock;</div><div class="line">  return *addr;</div><div class="line">&#125;</div><div class="line"></div><div class="line">void</div><div class="line">sun::misc::Unsafe::unpark (::java::lang::Thread *thread)</div><div class="line">&#123;</div><div class="line">  natThread *nt = (natThread *) thread-&gt;data;</div><div class="line">  nt-&gt;park_helper.unpark ();</div><div class="line">&#125;</div><div class="line"></div><div class="line">void</div><div class="line">sun::misc::Unsafe::park (jboolean isAbsolute, jlong time)</div><div class="line">&#123;</div><div class="line">  using namespace ::java::lang;</div><div class="line">  Thread *thread = Thread::currentThread();</div><div class="line">  natThread *nt = (natThread *) thread-&gt;data;</div><div class="line">  nt-&gt;park_helper.park (isAbsolute, time);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://www.cnblogs.com/mickole/articles/3757278.html" target="_blank" rel="external">Link</a></p>

      
    </div>
    
      
    
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2015/12/08/Java-Unsafe-2/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          Java Unsafe compareAndSwap 并发
        
      </div>
    </a>
  
  
    <a href="/2015/10/03/Java-Lock-Condition/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">Java Condition 线程间通信</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share_jia">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">Share to: &nbsp; </span>
		<a class="jiathis_button_facebook"></a> 
    <a class="jiathis_button_twitter"></a>
    <a class="jiathis_button_plus"></a> 
    <a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>








</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2014 - 2018 Michael Cai
    	</div>
      <div class="footer-left">
        &nbsp;&copy; 
        <span  id="busuanzi_container_site_pv"  style="display: none;">
          本站访问量<span id="busuanzi_value_site_pv"></span>次
        </span>
        <span id="busuanzi_container_site_uv" style="display: none;">
          访客数<span id="busuanzi_value_site_uv"></span>人
        </span>
      </div>
      	<div class="footer-right">
      		Theme of <a href="https://github.com/Mike-bel/hexo-theme-yilia-optimization" target="_blank">yilia-opti</a>, by Michael Cai
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: '/'
	}
</script>
<script src="/js/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>



<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-83125745-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->




<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script>
	(function(){
		document.write('<scr'+'ipt type="text/javascript" src="'+document.location.protocol+'//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">'+'</sc'+'ript>');
	})();
</script>



<script async src="/js/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>